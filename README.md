# Payments Engine

A simple toy payments engine that processes financial transactions from CSV files, handling deposits, withdrawals, disputes, resolutions, and chargebacks.

## Features

- **Transaction Processing**: Handles deposits, withdrawals, disputes, resolves, and chargebacks
- **Account Management**: Tracks available, held, and total funds for each client
- **Dispute Handling**: Supports the full dispute lifecycle from dispute to resolution or chargeback
- **Safety**: Prevents insufficient fund withdrawals and locks accounts after chargebacks
- **Precision**: Uses [`rust_decimal::Decimal`](https://docs.rs/rust_decimal/latest/rust_decimal/struct.Decimal.html) for financial calculations
- **Error Handling**: Robust error handling with detailed error types

## Usage

```bash
cargo run --release -- transactions.csv > accounts.csv
```

## Input Format

The input CSV should have columns: `type`, `client`, `tx`, and `amount`.

Example:

```csv
type,client,tx,amount
deposit,1,1,1.0
deposit,2,2,2.0
withdrawal,1,3,1.5
dispute,1,1,
resolve,1,1,
```

## Output Format

The output CSV contains: `client`, `available`, `held`, `total`, and `locked`.

Example:

```csv
client,available,held,total,locked
1,1.5,0,1.5,false
2,2,0,2,false
```

## Error handling

The system uses [`thiserror`](crates.io/crates/thiserror) for structured error handling with specific error types:

- `InsufficientFunds`: When withdrawals exceed available balance
- `TransactionNotFound`: When disputes/resolves reference non-existent transactions
- `TransactionNotDisputed`: When resolves/chargebacks reference non-disputed transactions
- `TransactionAlreadyDisputed`: When resolves/chargebacks reference transactions already under dispute
- `AccountLocked`: When operations are attempted on locked accounts
- `InvalidAmount`: When amounts are negative values for deposits/withdrawals
- `InvalidTransactionType`: When an unsupported transaction type is encountered during disputes. This shouldn't occur as dispute transactions are not stored.

**IMPORTANT**: All errors are logged but don't stop processing other transactions. The output CSV will contain the final state of accounts after processing all valid transactions.

## Testing

Comprehensive unit tests cover:

- Basic deposit/withdrawal operations
- Insufficient funds handling
- Complete dispute lifecycle (dispute â†’ resolve/chargeback)
- Multiple client scenarios
- CSV parsing edge cases

## AI usage disclosure

This code was written by a human - me, but with some help from AI autocomplete using [zbirenbaum/copilot.lua](https://github.com/zbirenbaum/copilot.lua). This README however was like 90% generated by AI.
